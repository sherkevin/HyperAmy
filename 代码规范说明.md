# HyperAmy 代码协作规范文档

## 目录

1. [包管理：使用 uv](#包管理使用-uv)
2. [项目结构说明](#项目结构说明)
3. [项目理念与设计原则](#项目理念与设计原则)
4. [开发规范](#开发规范)
5. [模块依赖关系](#模块依赖关系)

---

## 包管理：使用 uv

### 什么是 uv？

`uv` 是一个极快的 Python 包管理器和项目管理工具，由 Astral 开发。它提供了类似 `pip`、`pip-tools`、`virtualenv`、`poetry` 等功能，但速度更快。

### 安装 uv

```bash
# Linux/macOS
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows (PowerShell)
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"

# 或使用 pip
pip install uv
```

### uv 基本使用

#### 1. 初始化项目

```bash
# 在项目根目录初始化 uv 项目
uv init

# 这会创建 pyproject.toml 文件
```

#### 2. 添加依赖

```bash
# 添加单个依赖
uv add requests python-dotenv numpy pandas chromadb

# 添加开发依赖
uv add --dev pytest black mypy

# 添加可选依赖组
uv add --optional dev
```

#### 3. 安装依赖

```bash
# 安装所有依赖（包括开发依赖）
uv sync

# 只安装生产依赖
uv sync --no-dev

# 安装并创建虚拟环境
uv venv
uv pip install -r requirements.txt  # 如果使用传统 requirements.txt
```

#### 4. 运行命令

```bash
# 在虚拟环境中运行 Python 脚本
uv run python script.py

# 运行测试
uv run pytest

# 运行模块
uv run python -m test.test_emotion
```

#### 5. 更新依赖

```bash
# 更新所有依赖到最新版本
uv lock --upgrade

# 更新特定依赖
uv add requests@latest
```

#### 6. 查看依赖树

```bash
# 查看依赖关系
uv tree

# 查看特定包的依赖
uv tree requests
```

#### 7. 导出依赖

```bash
# 导出为 requirements.txt（兼容性）
uv pip compile pyproject.toml -o requirements.txt

# 导出为 requirements-dev.txt
uv pip compile pyproject.toml --dev -o requirements-dev.txt
```

### 项目中的 uv 配置示例

在项目根目录创建 `pyproject.toml`：

```toml
[project]
name = "hyperamy"
version = "1.2.0"
description = "一个集成了情感分析、实体抽取和双曲空间存储的 LLM 应用框架"
requires-python = ">=3.8"
dependencies = [
    "requests",
    "python-dotenv",
    "numpy",
    "pandas",
    "chromadb",
]

[project.optional-dependencies]
dev = [
    "pytest",
    "black",
    "mypy",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

### uv 的优势

1. **极快的速度**：比 pip 快 10-100 倍
2. **统一的工具**：替代 pip、virtualenv、pip-tools 等多个工具
3. **兼容性**：完全兼容 pip 和 PyPI
4. **跨平台**：支持 Linux、macOS、Windows
5. **更好的依赖解析**：更快的依赖解析算法

---

## 项目结构说明

### 目录结构

```
HyperAmy/
├── llm/                    # LLM 客户端模块（基础功能）
│   ├── __init__.py         # 模块导出
│   ├── config.py           # 配置管理（从 .env 读取 API_KEY 和 BASE_URL）
│   ├── completion_client.py # LLM 客户端（支持 normal 和 specific 两种模式）
│   └── README.md           # LLM 模块详细文档
│
├── point_label/            # 点标签模块（功能模块）
│   ├── __init__.py         # 模块导出
│   ├── emotion.py          # 情感向量提取（输入 chunk，输出 emotion vector）
│   ├── emotion_v2.py       # 情感向量提取 V2（增强版）
│   ├── labels.py           # 记忆深度和温度计算
│   ├── speed.py            # 惊讶值计算（基于 token 概率）
│   └── temperature.py      # 温度计算（待实现）
│
├── poincare/               # 双曲空间存储与检索模块（功能模块）
│   ├── __init__.py
│   ├── types.py            # 数据类型定义（Point, SearchResult）
│   ├── physics.py          # 双曲空间物理计算（TimePhysics, ParticleProjector）
│   ├── storage.py          # 双曲空间存储（HyperAmyStorage）
│   ├── retrieval.py        # 双曲空间检索（HyperAmyRetrieval）
│   └── linking.py          # 双曲空间链接构建
│
├── utils/                  # 工具模块（基础功能）
│   ├── entitiy.py          # 实体抽取（基于 HippoRAG 的 OpenIE）
│   └── sentence.py         # 句子处理（实体识别 + 情感视角描述生成）
│
├── prompts/                # Prompt 模板管理模块（基础功能）
│   ├── __init__.py
│   ├── prompt_template_manager.py  # Prompt 模板管理器
│   └── templates/          # Prompt 模板目录
│       ├── __init__.py
│       ├── affective_description.py  # 情感描述模板
│       └── emotion_extraction.py     # 情感提取模板
│
├── hipporag/               # 外部依赖（HippoRAG 框架）
│   └── ...                 # HippoRAG 相关代码
│
├── test/                   # 测试文件
│   ├── test_emotion.py     # 测试情感向量提取
│   ├── test_emotion_v2.py  # 测试情感向量提取 V2
│   ├── test_labels.py      # 测试记忆深度和温度计算
│   ├── test_speed.py       # 测试惊讶值计算
│   ├── test_entity.py      # 测试实体抽取
│   ├── test_sentence.py    # 测试句子处理
│   ├── test_poincare.py    # 测试双曲空间存储和检索
│   └── test_linking.py    # 测试双曲空间链接
│
├── log/                    # 日志目录
├── outputs/                # 输出目录
├── test_db/                # 测试数据库目录
├── README.md               # 项目主文档
└── CODE_COLLABORATION.md   # 本文档
```

### 各模块详细说明

#### 1. `llm/` - LLM 客户端模块（基础功能）

**作用**：提供统一的 LLM API 客户端封装，是整个项目的基础依赖。

**文件说明**：
- `config.py`：统一管理 API 配置，从 `.env` 文件读取 `API_KEY` 和 `BASE_URL`
- `completion_client.py`：LLM 客户端实现，支持两种模式：
  - `normal` 模式：使用 Chat Completions API，返回 `ChatResult`
  - `specific` 模式：使用 Completions API，返回 `CompletionResult`（包含 token 概率信息）
- `__init__.py`：导出主要类和函数，提供便捷的导入接口

**使用示例**：
```python
from llm import create_client
from llm.config import DEFAULT_MODEL

client = create_client(model_name=DEFAULT_MODEL)
result = client.complete("你好", mode="normal")
```

**设计原则**：
- 所有其他模块都依赖此模块，但不应该被其他模块反向依赖
- 提供统一的接口，隐藏底层 API 细节
- 支持多种模式，满足不同场景需求

---

#### 2. `point_label/` - 点标签模块（功能模块）

**作用**：提供文本特征提取功能，包括情感向量、记忆深度、温度、惊讶值等。

**文件说明**：
- `emotion.py`：基础情感向量提取（30 维向量，基于 Plutchik 情绪轮）
- `emotion_v2.py`：增强版情感向量提取（支持更复杂的情感分析）
- `labels.py`：记忆深度和温度计算（依赖 `emotion.py`）
- `speed.py`：惊讶值计算（基于 token 概率，依赖 `llm` 模块）
- `temperature.py`：温度计算（待实现）

**使用示例**：
```python
from point_label.emotion import Emotion
from point_label.labels import Labels
from point_label.speed import Speed

emotion = Emotion()
vector = emotion.extract("I'm very happy!")

labels = Labels()
result = labels.extract("I'm very happy!", use_specific=True)

speed = Speed()
surprise = speed.extract("Quantum entanglement...", aggregation="mean")
```

**设计原则**：
- 每个文件实现一个独立的功能点
- 可以独立使用，也可以组合使用
- 依赖 `llm` 模块，但不依赖其他功能模块

---

#### 3. `poincare/` - 双曲空间存储与检索模块（功能模块）

**作用**：实现基于 Poincaré 球的情绪记忆系统，提供双曲空间存储和检索功能。

**文件说明**：
- `types.py`：数据类型定义（`Point`、`SearchResult` 等）
- `physics.py`：双曲空间物理计算（`TimePhysics`、`ParticleProjector`）
- `storage.py`：双曲空间存储（`HyperAmyStorage`，基于 ChromaDB）
- `retrieval.py`：双曲空间检索（`HyperAmyRetrieval`，混合检索）
- `linking.py`：双曲空间链接构建

**使用示例**：
```python
from poincare import HyperAmyStorage, HyperAmyRetrieval
from poincare.types import Point

storage = HyperAmyStorage(db_path="./hyperamy_db")
point = Point(content="I'm very happy!", emotion_vector=vector, ...)
storage.add_point(point)

retrieval = HyperAmyRetrieval(storage)
results = retrieval.search("happy", top_k=5)
```

**设计原则**：
- 可以独立使用，也可以与 `point_label` 模块组合使用
- 依赖 `llm` 模块（用于嵌入），但不依赖其他功能模块
- 提供清晰的接口，隐藏双曲空间计算的复杂性

---

#### 4. `utils/` - 工具模块（基础功能）

**作用**：提供通用的工具函数和类，供其他模块使用。

**文件说明**：
- `entitiy.py`：实体抽取（基于 HippoRAG 的 OpenIE）
- `sentence.py`：句子处理（实体识别 + 情感视角描述生成）

**使用示例**：
```python
from utils.entitiy import Entity
from utils.sentence import Sentence

entity = Entity()
entities = entity.extract_entities("Barack Obama was the 44th president.")

sentence = Sentence()
result = sentence.process_sentence("I love this movie!")
```

**设计原则**：
- 提供可复用的基础功能
- 可以被多个功能模块使用
- 依赖 `llm` 和 `prompts` 模块，但不依赖功能模块

---

#### 5. `prompts/` - Prompt 模板管理模块（基础功能）

**作用**：统一管理项目中的 prompt 模板，提供模板加载和渲染功能。

**文件说明**：
- `prompt_template_manager.py`：Prompt 模板管理器（参照 hipporag 的组织形式）
- `templates/`：Prompt 模板目录
  - `affective_description.py`：情感描述模板
  - `emotion_extraction.py`：情感提取模板

**使用示例**：
```python
from prompts.prompt_template_manager import PromptTemplateManager

manager = PromptTemplateManager()
prompt = manager.render('affective_description', sentence="...", entity="...")
```

**设计原则**：
- 统一管理所有 prompt 模板，避免硬编码
- 支持字符串模板和聊天历史模板
- 可以被多个模块使用，但不依赖其他模块

---

#### 6. `test/` - 测试文件

**作用**：为各个模块提供单元测试和集成测试。

**文件说明**：
- 每个测试文件对应一个模块或功能点
- 测试文件命名规范：`test_<module_name>.py`

**运行方式**：
```bash
# 使用 uv 运行测试
uv run python -m test.test_emotion
uv run python -m test.test_sentence

# 或使用 pytest
uv run pytest test/test_emotion.py
```

**设计原则**：
- 每个模块都应该有对应的测试文件
- 测试应该独立运行，不依赖外部资源（如数据库）
- 使用 `python -m` 方式运行，避免路径问题

---

## 项目理念与设计原则

### 核心理念

1. **多复用**：基础功能模块应该被多个功能模块复用，避免重复实现
2. **解耦**：不同功能模块之间应该解耦，可以独立开发、测试和部署
3. **功能分块实现**：每个功能点应该独立实现，形成清晰的模块边界
4. **依赖基础功能但不耦合**：功能模块可以依赖基础功能模块，但功能模块之间不应该相互依赖

### 设计原则详解

#### 1. 分层架构

项目采用分层架构，分为三层：

```
┌─────────────────────────────────────┐
│     功能模块层（功能模块）            │
│  point_label, poincare, ...        │
│  （可以独立使用，互不依赖）           │
└──────────────┬──────────────────────┘
               │ 依赖
┌──────────────┴──────────────────────┐
│     基础功能层（基础功能）            │
│  llm, utils, prompts                │
│  （提供可复用的基础功能）             │
└──────────────┬──────────────────────┘
               │ 依赖
┌──────────────┴──────────────────────┐
│     外部依赖层                       │
│  hipporag, chromadb, ...            │
└─────────────────────────────────────┘
```

#### 2. 模块依赖规则

**允许的依赖关系**：
- ✅ 功能模块 → 基础功能模块（如 `point_label` → `llm`）
- ✅ 功能模块 → 外部依赖（如 `poincare` → `chromadb`）
- ✅ 基础功能模块 → 外部依赖（如 `llm` → `requests`）

**禁止的依赖关系**：
- ❌ 功能模块 → 功能模块（如 `point_label` → `poincare`）
- ❌ 基础功能模块 → 功能模块（如 `llm` → `point_label`）
- ❌ 基础功能模块 → 基础功能模块（如 `llm` → `utils`，除非必要）

#### 3. 接口设计原则

**清晰的接口**：
- 每个模块应该提供清晰的公共接口（通过 `__init__.py` 导出）
- 接口应该稳定，避免频繁变更
- 接口应该简洁，隐藏实现细节

**示例**：
```python
# ✅ 好的接口设计
from point_label import Emotion
emotion = Emotion()
vector = emotion.extract(chunk)

# ❌ 不好的接口设计（暴露了太多实现细节）
from point_label.emotion import EmotionExtractor, PlutchikEmotionWheel, ...
```

#### 4. 配置管理原则

**统一配置**：
- 所有配置通过 `llm.config` 模块统一管理
- 环境变量通过 `.env` 文件管理
- 不要在代码中硬编码配置值

**示例**：
```python
# ✅ 好的做法
from llm.config import DEFAULT_MODEL, API_KEY
client = create_client(model_name=DEFAULT_MODEL)

# ❌ 不好的做法
client = create_client(model_name="DeepSeek-V3.2")  # 硬编码
```

#### 5. 错误处理原则

**优雅降级**：
- 模块应该提供默认值或优雅降级机制
- 错误应该被记录，但不应该中断整个流程
- 使用日志记录错误，而不是直接打印

**示例**：
```python
# ✅ 好的错误处理
try:
    description = self.generate_affective_description(sentence, entity)
    descriptions[entity] = description
except Exception as e:
    logger.warning(f"Failed to generate description for entity '{entity}': {e}")
    descriptions[entity] = ""  # 优雅降级
```

---

## 开发规范

### 1. 代码风格

**Python 代码风格**：
- 遵循 PEP 8 规范
- 使用类型提示（Type Hints）
- 使用文档字符串（Docstrings）

**示例**：
```python
def extract(self, chunk: str) -> np.ndarray:
    """
    提取情感向量
    
    Args:
        chunk: 输入文本块
        
    Returns:
        np.ndarray: 30 维情感向量（归一化）
    """
    ...
```

### 2. 模块导出规范

**`__init__.py` 规范**：
- 每个模块的 `__init__.py` 应该明确导出公共接口
- 使用 `__all__` 明确导出列表
- 避免导出私有函数和类（以下划线开头）

**示例**：
```python
# point_label/__init__.py
from .emotion import Emotion
from .emotion_v2 import EmotionV2, EmotionNode

__all__ = ['Emotion', 'EmotionV2', 'EmotionNode']
```

### 3. 测试规范

**测试文件规范**：
- 每个模块应该有对应的测试文件
- 测试文件命名：`test_<module_name>.py`
- 测试函数命名：`test_<function_name>`

**运行测试**：
```bash
# 使用 python -m 方式运行（推荐）
uv run python -m test.test_emotion

# 或使用 pytest
uv run pytest test/test_emotion.py
```

### 4. 日志规范

**日志使用**：
- 使用 `hipporag.utils.logging_utils.get_logger` 获取 logger
- 使用适当的日志级别（DEBUG、INFO、WARNING、ERROR）
- 日志信息应该清晰、有用

**示例**：
```python
from hipporag.utils.logging_utils import get_logger

logger = get_logger(__name__)

logger.info(f"Sentence initialized with model: {self.model_name}")
logger.debug(f"Generated affective description: {description[:50]}...")
logger.warning(f"Failed to generate description: {e}")
logger.error(f"Critical error: {e}")
```

### 5. 文档规范

**文档要求**：
- 每个模块应该有清晰的文档字符串
- 公共函数和类应该有详细的文档
- 复杂逻辑应该有注释说明

**文档格式**：
```python
class Emotion:
    """
    情感向量提取类
    
    功能：
    - 输入 chunk，输出 30 维情感向量
    - 基于 Plutchik 情绪轮和扩展情绪列表
    
    使用示例：
        emotion = Emotion()
        vector = emotion.extract("I'm very happy!")
    """
    
    def extract(self, chunk: str) -> np.ndarray:
        """
        提取情感向量
        
        Args:
            chunk: 输入文本块
            
        Returns:
            np.ndarray: 30 维情感向量（归一化）
        """
        ...
```

---

## 模块依赖关系

### 依赖关系图

```
point_label (功能模块)
    ├── llm (基础功能)
    └── prompts (基础功能，可选)

poincare (功能模块)
    ├── llm (基础功能)
    └── chromadb (外部依赖)

utils (基础功能)
    ├── llm (基础功能)
    ├── prompts (基础功能)
    └── hipporag (外部依赖)

prompts (基础功能)
    └── hipporag (外部依赖，仅用于日志)

llm (基础功能)
    └── requests, python-dotenv (外部依赖)
```

### 依赖说明

1. **功能模块之间的依赖**：
   - `point_label` 和 `poincare` 之间**不应该**有依赖关系
   - 如果需要在功能模块之间共享代码，应该将其提取到基础功能模块

2. **基础功能模块之间的依赖**：
   - `llm` 模块不应该依赖其他基础功能模块
   - `utils` 可以依赖 `llm` 和 `prompts`
   - `prompts` 可以依赖 `llm`（如果需要）

3. **循环依赖**：
   - **严格禁止**循环依赖
   - 如果发现循环依赖，应该重构代码，提取公共部分

### 添加新模块的检查清单

在添加新模块时，请检查：

- [ ] 模块属于哪一层？（功能模块 / 基础功能模块）
- [ ] 模块依赖哪些其他模块？
- [ ] 是否存在循环依赖？
- [ ] 是否违反了依赖规则？
- [ ] 是否提供了清晰的公共接口？
- [ ] 是否有对应的测试文件？
- [ ] 是否有文档说明？

---

## 总结

本规范文档旨在确保 HyperAmy 项目的代码质量和可维护性。通过遵循这些规范，我们可以：

1. **提高代码复用性**：基础功能模块可以被多个功能模块复用
2. **降低耦合度**：功能模块之间解耦，可以独立开发
3. **简化协作**：不同开发者可以并行开发不同功能模块
4. **提高可维护性**：清晰的模块边界和依赖关系，便于维护和扩展

如有任何问题或建议，请及时反馈。

