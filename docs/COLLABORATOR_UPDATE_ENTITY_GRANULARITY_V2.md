# å®ä½“ç²’åº¦æ•°æ®é›†ç”Ÿæˆè„šæœ¬æ”¹è¿›ç‰ˆ v2 - åˆä½œè€…æ›´æ–°

## ğŸ“‹ æ¦‚è¿°

æˆ‘ä»¬å‘å¸ƒäº†å¯¹å®ä½“ç²’åº¦æƒ…ç»ªæ•°æ®é›†ç”Ÿæˆè„šæœ¬çš„é‡å¤§æ”¹è¿›ç‰ˆæœ¬ï¼ˆv2ï¼‰ï¼Œè§£å†³äº†ä¹‹å‰ç‰ˆæœ¬ä¸­çš„å‡ ä¸ªå…³é”®é—®é¢˜ï¼Œå¹¶æ·»åŠ äº†æ–°çš„åŠŸèƒ½ä»¥æå‡æ•°æ®è´¨é‡å’Œæ¨¡å‹è®­ç»ƒæ•ˆæœã€‚

## ğŸ”§ ä¸»è¦æ”¹è¿›

### 1. è¿‡æ»¤ç« èŠ‚æ ‡é¢˜é—®é¢˜ âœ…

**é—®é¢˜**ï¼šåŸå§‹æ•°æ®ä¸­åŒ…å«å¤§é‡ç« èŠ‚æ ‡é¢˜ï¼ˆå¦‚"Marseillesâ€”The Arrival\nChapter 2"ï¼‰ï¼Œå¯¼è‡´å®ä½“æå–æ—¶é¢‘ç¹æå–åˆ°"Chapter"ç­‰æ— æ„ä¹‰çš„å®ä½“ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ æ™ºèƒ½ç« èŠ‚æ ‡é¢˜æ£€æµ‹å’Œè¿‡æ»¤æœºåˆ¶
- è‡ªåŠ¨æ¸…ç†åŒ…å«"Chapter"çš„çŸ­æ–‡æœ¬
- æ˜¾è‘—æå‡æ•°æ®è´¨é‡ï¼Œå‡å°‘å™ªå£°

### 2. soft_labelå½’ä¸€åŒ–æ”¹è¿› âœ…

**é—®é¢˜**ï¼šåŸç‰ˆæœ¬å¯¹28ç»´æƒ…ç»ªå‘é‡è¿›è¡Œå…¨å±€å½’ä¸€åŒ–ï¼ˆsum=1.0ï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰å‘é‡çš„æ¨¡é•¿å›ºå®šï¼Œæ— æ³•åæ˜ æƒ…ç»ªå¼ºåº¦çš„çœŸå®å˜åŒ–ã€‚

**æ”¹è¿›**ï¼š
- **ä¸å†è¿›è¡Œå…¨å±€å½’ä¸€åŒ–**ï¼šæ¯ä¸ªç»´åº¦ç‹¬ç«‹é™åˆ¶åœ¨[0, 1]èŒƒå›´
- **ä¿æŒæ¨¡é•¿å¯å˜**ï¼šå‘é‡çš„L2-normå¯ä»¥å˜åŒ–ï¼Œæ›´å¥½åœ°åæ˜ æƒ…ç»ªå¼ºåº¦
- **ä½¿ç”¨L2-normè®¡ç®—intensity**ï¼šæ›´åˆç†çš„å¼ºåº¦åº¦é‡æ–¹å¼

**æŠ€æœ¯ç»†èŠ‚**ï¼š
```python
# æ—§ç‰ˆæœ¬ï¼ˆé”™è¯¯ï¼‰ï¼š
soft_label = [s / sum(soft_label) for s in soft_label]  # å½’ä¸€åŒ–ï¼Œsum=1.0

# æ–°ç‰ˆæœ¬ï¼ˆæ­£ç¡®ï¼‰ï¼š
soft_label = [max(0.0, min(1.0, s)) for s in soft_label]  # åªé™åˆ¶èŒƒå›´ï¼Œä¸å½’ä¸€åŒ–
intensity = np.linalg.norm(soft_label)  # L2-normï¼Œåæ˜ çœŸå®å¼ºåº¦
```

### 3. æ”¯æŒQAå¯¹æ•°æ® âœ…

**éœ€æ±‚**ï¼šä¸ºäº†æå‡emotion embedding modelåœ¨QAæ£€ç´¢ä»»åŠ¡ä¸Šçš„æ€§èƒ½ï¼Œéœ€è¦å°†QAå¯¹åŠ å…¥è®­ç»ƒé›†ï¼Œå¹¶ç¡®ä¿é—®é¢˜å’Œå¯¹åº”ç­”æ¡ˆçš„å®ä½“æƒ…ç»ªå‘é‡å°½å¯èƒ½ç›¸è¿‘ã€‚

**å®ç°**ï¼š
- æ·»åŠ ä¸“é—¨çš„QAå¯¹å¤„ç†é€»è¾‘
- ä½¿ç”¨ç‰¹æ®Šçš„promptå¼•å¯¼LLMç”Ÿæˆç›¸ä¼¼çš„æƒ…ç»ªå‘é‡ï¼ˆæš—ç¤ºä½†ä¸æ˜æ˜¾ï¼‰
- æ”¯æŒæ§åˆ¶QAå¯¹åœ¨æ€»æ•°æ®ä¸­çš„æ¯”ä¾‹ï¼ˆé»˜è®¤30%ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼šè®­ç»ƒåçš„emotion embedding modelåœ¨QAé—®ç­”åœºæ™¯ä¸­èƒ½å¤Ÿè‡ªç„¶åœ°æ£€ç´¢åˆ°ä¸é—®é¢˜æƒ…ç»ªç›¸ä¼¼çš„ç›¸å…³ç­”æ¡ˆã€‚

### 4. æ”¯æŒå¤šæ•°æ®æº âœ…

- æ”¯æŒä»å¤šä¸ªè®­ç»ƒæ–‡ä»¶åŠ è½½æ•°æ®
- æ”¯æŒä»å¤šä¸ªQAæ–‡ä»¶åŠ è½½æ•°æ®
- è‡ªåŠ¨åˆå¹¶å’Œæ··åˆä¸åŒæ•°æ®æº
- æ›´çµæ´»çš„æ•°æ®é›†æ„å»ºæ–¹å¼

## ğŸ“Š æ•°æ®æ ¼å¼å˜åŒ–

### soft_labelæ ¼å¼å˜åŒ–

**æ—§æ ¼å¼**ï¼ˆå½’ä¸€åŒ–ï¼‰ï¼š
```json
{
  "soft_label": [0.01, 0.02, 0.85, 0.05, ...],  // sum = 1.0
  "intensity": 0.85  // Max-Norm
}
```

**æ–°æ ¼å¼**ï¼ˆä¸å½’ä¸€åŒ–ï¼‰ï¼š
```json
{
  "soft_label": [0.01, 0.02, 0.85, 0.05, ...],  // æ¯ä¸ªç»´åº¦åœ¨[0,1]ï¼Œsumä¸ä¸€å®š=1.0
  "intensity": 0.92  // L2-normï¼ˆæ›´åˆç†ï¼‰
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨
```bash
python scripts/generate_entity_granularity_dataset_v2.py \
  --training-files data/training/monte_cristo_train_full.jsonl \
  --output data/training/entity_granularity/entity_granularity_v2.jsonl
```

### åŒ…å«QAå¯¹ï¼ˆæ¨èï¼‰
```bash
python scripts/generate_entity_granularity_dataset_v2.py \
  --training-files data/training/monte_cristo_train_full.jsonl \
  --qa-files data/public_benchmark/monte_cristo_qa_full.json \
  --qa-ratio 0.3 \
  --output data/training/entity_granularity/entity_granularity_v2.jsonl \
  --max-workers 10
```

### å¤šæ•°æ®æº
```bash
python scripts/generate_entity_granularity_dataset_v2.py \
  --training-files \
    data/training/monte_cristo_train_full.jsonl \
    data/training/other_source.jsonl \
  --qa-files \
    data/public_benchmark/monte_cristo_qa_full.json \
    data/benchmarks/instinct_qa.json \
  --qa-ratio 0.3 \
  --output data/training/entity_granularity/entity_granularity_v2.jsonl
```

## ğŸ“ æ–‡ä»¶ä½ç½®

- **æ–°è„šæœ¬**ï¼š`scripts/generate_entity_granularity_dataset_v2.py`
- **æ—§è„šæœ¬**ï¼š`scripts/generate_entity_granularity_dataset.py`ï¼ˆä¿ç•™ï¼Œä½†ä¸æ¨èä½¿ç”¨ï¼‰
- **è¯¦ç»†æ–‡æ¡£**ï¼š`docs/ENTITY_GRANULARITY_DATASET_V2_IMPROVEMENTS.md`

## âœ… éªŒè¯ç»“æœ

æ–°è„šæœ¬å·²é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š
- âœ… æ•°æ®æ ¼å¼æ­£ç¡®æ€§æ£€æŸ¥
- âœ… soft_labelç»´åº¦éªŒè¯ï¼ˆ28ç»´ï¼‰
- âœ… soft_labelèŒƒå›´éªŒè¯ï¼ˆ[0, 1]ï¼‰
- âœ… intensityè®¡ç®—éªŒè¯ï¼ˆL2-normï¼‰
- âœ… ç« èŠ‚æ ‡é¢˜è¿‡æ»¤éªŒè¯
- âœ… å­—ç¬¦ä½ç½®ä¸€è‡´æ€§éªŒè¯
- âœ… QAå¯¹å¤„ç†éªŒè¯

## ğŸ¯ é¢„æœŸæ”¶ç›Š

1. **æ•°æ®è´¨é‡æå‡**ï¼š
   - è¿‡æ»¤æ— ç”¨æ–‡æœ¬ï¼ˆç« èŠ‚æ ‡é¢˜ç­‰ï¼‰
   - æ›´å‡†ç¡®çš„å®ä½“æå–
   - æ›´ä¸°å¯Œçš„æƒ…ç»ªå†…å®¹

2. **æ¨¡å‹æ€§èƒ½æå‡**ï¼š
   - æƒ…ç»ªå¼ºåº¦é¢„æµ‹æ›´å‡†ç¡®ï¼ˆæ¨¡é•¿å¯å˜ï¼‰
   - QAæ£€ç´¢æ€§èƒ½æå‡ï¼ˆQå’ŒAæƒ…ç»ªå‘é‡ç›¸è¿‘ï¼‰
   - æ›´å¥½çš„æ³›åŒ–èƒ½åŠ›

3. **å¼€å‘æ•ˆç‡æå‡**ï¼š
   - æ”¯æŒå¤šæ•°æ®æºï¼Œæ›´çµæ´»
   - æ›´å¥½çš„æ•°æ®è´¨é‡æ§åˆ¶
   - æ›´å®¹æ˜“æ‰©å±•å’Œç»´æŠ¤

## ğŸ“ ä¸‹ä¸€æ­¥

å»ºè®®ä½¿ç”¨æ–°ç‰ˆæœ¬è„šæœ¬é‡æ–°ç”Ÿæˆæ•°æ®é›†ï¼Œä»¥è·å¾—æ›´å¥½çš„è®­ç»ƒæ•ˆæœã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»ã€‚

---

**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-11  
**ç‰ˆæœ¬**ï¼šv2  
**çŠ¶æ€**ï¼šâœ… å·²éªŒè¯ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ
